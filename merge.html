<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PDF Merger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>

<!-- pdf-lib -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

<style>
/* ==== UI STYLE ==== */
* {
    box-sizing: border-box;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
}

body {
    margin: 0;
    background: radial-gradient(1200px 600px at 50% -200px, #142035, #05080f);
    color: #e5e7eb;
}

#root {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 28px 16px;
}

#drop-zone {
    width: 440px;
    max-width: 100%;
    height: 120px;
    border-radius: 18px;
    border: 2px dashed rgba(110,231,183,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: rgba(255,255,255,0.04);
    margin-bottom: 18px;
}

#grid {
    width: min(90vw, 760px); /* ‚Üê –¥–æ 6 –∫–∞—Ä—Ç–æ—á–µ–∫ */
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(112px, 1fr));
    gap: 16px;
    justify-content: center;
    margin-bottom: 18px;
}

.pdf-card {
    width: 112px;
    height: 148px;
    border-radius: 18px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.08);
    position: relative;
    cursor: grab;
    overflow: hidden;
}

.pdf-card.dragging {
    opacity: .45;
}

.thumb {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.card-btn {
    position: absolute;
    top: 8px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: rgba(0,0,0,.6);
    color: white;
    border: none;
    cursor: pointer;
}

.preview { right: 44px; }
.delete { right: 8px; }

.badge {
    position: absolute;
    left: 8px;
    bottom: 8px;
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 999px;
    background: rgba(0,0,0,.6);
}

.drop-placeholder {
    width: 112px;
    height: 148px;
    border-radius: 18px;
    border: 2px dashed rgba(110,231,183,.7);
    background: rgba(110,231,183,.12);
}

input, button {
    width: 440px;
    height: 52px;
    margin-top: 10px;
    border-radius: 14px;
    border: none;
    font-size: 18px;
}

input {
    padding-left: 16px;
    background: rgba(255,255,255,.08);
    color: white;
}

button:enabled {
    background: #10b981;
    color: white;
    cursor: pointer;
}

/* MODAL */
#modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.85);
    display: none;
    justify-content: center;
    align-items: center;
}

#modal-panel {
    width: min(900px, 92vw);
    max-height: 86vh;
    background: #0b1220;
    border-radius: 18px;
    overflow-y: auto;
    padding: 20px;
    position: relative;
}

#modal-close {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 34px;
    height: 34px;
    border-radius: 50%;
    background: rgba(255,255,255,.1);
    color: white;
    border: none;
    cursor: pointer;
}

canvas.page {
    display: block;
    margin: 18px auto;
    max-width: 100%;
    background: white;
}
</style>
</head>

<body>
<div id="root">
    <div id="drop-zone">’î’°’∑’•÷Ñ ’Ø’°’¥ ’®’∂’ø÷Ä’•÷Ñ ’¥’´ ÷Ñ’°’∂’´ PDF ÷Ü’°’µ’¨</div>
    <input id="file-input" type="file" accept="application/pdf" multiple hidden>

    <div id="grid"></div>

    <input id="output-name" placeholder="‘µ’¶÷Ä’°÷É’°’Ø’´’π ÷Ü’°’µ’¨’´ ’°’∂’∏÷Ç’∂’®">
    <button id="merge-btn" disabled>’Ñ’´’°÷Å’∂’•’¨ ÷á ’∂’•÷Ä’¢’•’º’∂’•’¨ PDF</button>
</div>

<div id="modal">
    <div id="modal-panel">
        <button id="modal-close">‚úï</button>
        <div id="modal-body"></div>
    </div>
</div>

<script>
const { PDFDocument } = PDFLib;
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";

const dropZone = document.getElementById("drop-zone");
const fileInput = document.getElementById("file-input");
const grid = document.getElementById("grid");
const mergeBtn = document.getElementById("merge-btn");
const outputName = document.getElementById("output-name");

const modal = document.getElementById("modal");
const modalBody = document.getElementById("modal-body");
const modalClose = document.getElementById("modal-close");

let items = [];
let draggingId = null;

const placeholder = document.createElement("div");
placeholder.className = "drop-placeholder";

function uid() {
    return Math.random().toString(36).slice(2);
}

dropZone.onclick = () => fileInput.click();
fileInput.onchange = e => handleFiles(e.target.files);

async function handleFiles(files) {
    for (const file of files) {
        if (file.type !== "application/pdf") continue;
        const thumb = await renderThumb(file);
        items.push({ id: uid(), file, thumb });
    }
    renderGrid();
}

async function renderThumb(file) {
    const bytes = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
    const page = await pdf.getPage(1);
    const viewport = page.getViewport({ scale: .25 });

    const canvas = document.createElement("canvas");
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({
        canvasContext: canvas.getContext("2d"),
        viewport
    }).promise;

    return canvas;
}

function renderGrid() {
    grid.innerHTML = "";
    mergeBtn.disabled = items.length === 0;

    items.forEach((item, i) => {
        const card = document.createElement("div");
        card.className = "pdf-card";
        card.draggable = true;
        card.dataset.id = item.id;

        const thumb = document.createElement("canvas");
        thumb.className = "thumb";
        thumb.width = item.thumb.width;
        thumb.height = item.thumb.height;
        thumb.getContext("2d").drawImage(item.thumb, 0, 0);

        const del = document.createElement("button");
        del.className = "card-btn delete";
        del.textContent = "‚úï";
        del.onclick = e => {
            e.stopPropagation();
            items = items.filter(x => x.id !== item.id);
            renderGrid();
        };

        const eye = document.createElement("button");
        eye.className = "card-btn preview";
        eye.textContent = "üëÅ";
        eye.onclick = e => {
            e.stopPropagation();
            openModal(item.file);
        };

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = i + 1;

        card.ondragstart = () => {
            draggingId = item.id;
            card.classList.add("dragging");
            setTimeout(() => card.style.display = "none", 0);
        };

        card.ondragend = () => {
            draggingId = null;
            card.style.display = "";
            card.classList.remove("dragging");
            placeholder.remove();
            renderGrid();
        };

        card.append(thumb, del, eye, badge);
        grid.appendChild(card);
    });
}

grid.ondragover = e => {
    e.preventDefault();

    const cards = [...grid.querySelectorAll(".pdf-card:not(.dragging)")];

    let closest = null;
    let closestDist = Infinity;

    cards.forEach(card => {
        const rect = card.getBoundingClientRect();
        const cx = rect.left + rect.width / 2;
        const cy = rect.top + rect.height / 2;

        const dx = e.clientX - cx;
        const dy = e.clientY - cy;
        const dist = Math.hypot(dx, dy);

        if (dist < closestDist) {
            closestDist = dist;
            closest = card;
        }
    });

    if (!closest) {
        grid.appendChild(placeholder);
        return;
    }

    const rect = closest.getBoundingClientRect();
    const before =
        e.clientY < rect.top + rect.height / 2 ||
        (Math.abs(e.clientY - rect.top) < rect.height / 4 &&
         e.clientX < rect.left + rect.width / 2);

    grid.insertBefore(
        placeholder,
        before ? closest : closest.nextSibling
    );
};

grid.ondrop = e => {
    e.preventDefault();
    if (!draggingId) return;

    const from = items.findIndex(i => i.id === draggingId);
    const to = [...grid.children].indexOf(placeholder);

    const [moved] = items.splice(from, 1);
    items.splice(to, 0, moved);

    placeholder.remove();
    renderGrid();
};

async function openModal(file) {
    modal.style.display = "flex";
    modalBody.innerHTML = "";

    const pdf = await pdfjsLib.getDocument({
        data: await file.arrayBuffer()
    }).promise;

    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 1.2 });

        const canvas = document.createElement("canvas");
        canvas.className = "page";
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({
            canvasContext: canvas.getContext("2d"),
            viewport
        }).promise;

        modalBody.appendChild(canvas);
    }
}

modal.onclick = e => e.target === modal && (modal.style.display = "none");
modalClose.onclick = () => modal.style.display = "none";

mergeBtn.onclick = async () => {
    const merged = await PDFDocument.create();

    for (const it of items) {
        const pdf = await PDFDocument.load(await it.file.arrayBuffer());
        const pages = await merged.copyPages(pdf, pdf.getPageIndices());
        pages.forEach(p => merged.addPage(p));
    }

    const blob = new Blob([await merged.save()], { type: "application/pdf" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = (outputName.value || "merged") + ".pdf";
    a.click();
};
</script>
</body>
</html>
